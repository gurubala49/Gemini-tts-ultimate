<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Ultimate TTS (Stable Core)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@400;700&family=Orbitron:wght@500;700&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        retro: ['Playfair Display', 'serif'],
                        future: ['Orbitron', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* CSS Variables for Themes */
        :root {
            --bg-color: #f8fafc;
            --text-color: #0f172a;
            --panel-bg: #ffffff;
            --border-color: #e2e8f0;
            --accent-color: #2563eb;
            --btn-text: #ffffff;
            --log-bg: #1e293b;
            --log-text: #94a3b8;
        }

        /* Modern Theme */
        body.theme-modern {
            --bg-color: #f0f9ff;
            --text-color: #1e293b;
            --panel-bg: rgba(255, 255, 255, 0.95);
            --border-color: #bae6fd;
            --accent-color: #0ea5e9;
            --btn-text: #ffffff;
            font-family: 'Inter', sans-serif;
            background-image: radial-gradient(#e0f2fe 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* Retro Theme */
        body.theme-retro {
            --bg-color: #fdf6e3;
            --text-color: #5c4033;
            --panel-bg: #eee8d5;
            --border-color: #d3c6aa;
            --accent-color: #cb4b16;
            --btn-text: #fdf6e3;
            --log-bg: #3f3630;
            --log-text: #d3c6aa;
            font-family: 'Playfair Display', serif;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
        }

        /* Future Theme */
        body.theme-future {
            --bg-color: #030712;
            --text-color: #e2e8f0;
            --panel-bg: rgba(17, 24, 39, 0.85);
            --border-color: #22d3ee;
            --accent-color: #06b6d4;
            --btn-text: #000000;
            --log-bg: #000000;
            --log-text: #22d3ee;
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(0deg, rgba(34,211,238,0.1) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(34,211,238,0.1) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* Terminal Theme */
        body.theme-terminal {
            --bg-color: #000000;
            --text-color: #33ff00;
            --panel-bg: #0a0a0a;
            --border-color: #33ff00;
            --accent-color: #33ff00;
            --btn-text: #000000;
            --log-bg: #000000;
            --log-text: #33ff00;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Base Styles */
        body { background-color: var(--bg-color); color: var(--text-color); transition: background 0.5s ease, color 0.5s ease; }
        .skin-panel { background-color: var(--panel-bg); border: 1px solid var(--border-color); }
        .skin-input { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-color); }
        .skin-btn { background-color: var(--accent-color); color: var(--btn-text); }
        .skin-log { background-color: var(--log-bg); color: var(--log-text); border: 1px solid var(--border-color); }

        .loader {
            border: 3px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            width: 20px; height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .skin-log::-webkit-scrollbar { width: 8px; }
        .skin-log::-webkit-scrollbar-track { background: transparent; }
        .skin-log::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
    </style>
</head>
<body class="theme-modern min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold tracking-tight mb-1">Gemini Studio TTS</h1>
                <div class="flex items-center gap-2 opacity-75 text-sm">
                    <span class="inline-block w-2 h-2 rounded-full bg-current animate-pulse"></span>
                    <span>Persona Lock â€¢ Zero Temp â€¢ 9k Chunks</span>
                </div>
            </div>
            
            <div class="skin-panel px-3 py-2 rounded-lg backdrop-blur-md shadow-sm">
                <label class="text-xs uppercase font-bold tracking-wider opacity-60 block mb-1">Theme</label>
                <select id="themeSelect" class="bg-transparent outline-none cursor-pointer w-40 font-medium">
                    <option value="modern">ðŸ”¹ Modern</option>
                    <option value="retro">ðŸ“œ Retro Paper</option>
                    <option value="future">ðŸ”® Neon Future</option>
                    <option value="terminal">ðŸ“Ÿ Terminal</option>
                </select>
            </div>
        </div>

        <div class="skin-panel rounded-xl p-6 mb-6 shadow-sm transition-all duration-300">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="font-semibold text-sm">API Keys (Round-Robin)</label>
                        <span id="keyCountBadge" class="text-[10px] px-2 py-0.5 rounded-full border border-current hidden font-mono">0 Loaded</span>
                    </div>
                    <textarea id="apiKeys" rows="3" placeholder="Paste Google AI Studio keys here (One per line)..." 
                           class="skin-input w-full p-3 rounded-lg focus:ring-2 focus:ring-current outline-none text-xs font-mono"></textarea>
                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="rememberKey" class="w-4 h-4 rounded border-gray-300 accent-current">
                        <label for="rememberKey" class="ml-2 text-xs opacity-80 cursor-pointer">Remember keys</label>
                    </div>
                </div>

                <div>
                    <label class="block font-semibold text-sm mb-2">Voice Model</label>
                    <select id="voiceSelect" class="skin-input w-full p-3 rounded-lg outline-none mb-4">
                        <option value="Charon">Charon (Deep/Calm) - Recommended</option>
                        <option value="Fenrir">Fenrir (Energetic/Fast)</option>
                        <option value="Puck">Puck (Neutral/Chat)</option>
                        <option value="Kore">Kore (Professional/News)</option>
                        <option value="Aoede">Aoede (Soft/Story)</option>
                    </select>

                    <label class="block font-semibold text-sm mb-2">Language (Optional)</label>
                    <input type="text" id="langInput" placeholder="Auto-detect (or type 'Tamil', 'French')" 
                           class="skin-input w-full p-3 rounded-lg outline-none text-sm">
                </div>
            </div>
        </div>

        <div class="skin-panel rounded-xl p-6 mb-6 shadow-sm">
            <label class="block font-semibold text-sm mb-2">Text Content</label>
            <textarea id="textInput" rows="8" 
                      class="skin-input w-full p-4 rounded-lg focus:ring-2 focus:ring-current outline-none resize-y text-base leading-relaxed"
                      placeholder="Paste your text here. 9000 characters per chunk supported."></textarea>

            <div id="progressContainer" class="hidden mt-6">
                <div class="flex justify-between text-xs font-mono opacity-80 mb-1">
                    <span id="progressText">Initializing...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="w-full bg-gray-200/20 rounded-full h-3 overflow-hidden border border-current">
                    <div id="progressBar" class="bg-current h-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <div class="mt-6 flex justify-end gap-4">
                <button id="submitBtn" class="skin-btn px-8 py-3 rounded-lg font-bold shadow-lg hover:brightness-110 active:scale-95 transition-all flex items-center gap-3">
                    <span id="btnText">Generate Audio</span>
                    <div id="loadingSpinner" class="loader hidden"></div>
                </button>
            </div>
        </div>

        <div id="resultArea" class="hidden skin-panel p-6 rounded-xl border-2 mb-6 animate-pulse-slow relative overflow-hidden">
            <div class="absolute inset-0 bg-current opacity-5 pointer-events-none"></div>
            <div class="relative z-10 flex flex-col md:flex-row items-center gap-4 justify-between">
                <div>
                    <h3 class="font-bold text-lg">Processing Complete</h3>
                    <p class="text-xs opacity-70 font-mono" id="resultStats">Ready for download</p>
                </div>
                <div class="flex gap-3 w-full md:w-auto">
                    <audio id="audioPlayer" controls class="h-10 w-full md:w-48 opacity-90"></audio>
                    <a id="downloadLink" href="#" class="skin-btn px-4 py-2 rounded-lg font-bold text-sm flex items-center shadow-md whitespace-nowrap">
                        Download .WAV
                    </a>
                </div>
            </div>
        </div>

        <div class="skin-log rounded-lg p-4 font-mono text-xs h-64 overflow-y-auto shadow-inner">
            <div class="sticky top-0 bg-inherit border-b border-dashed border-current pb-2 mb-2 opacity-50 uppercase tracking-widest font-bold">
                System Process Log
            </div>
            <div id="logContent" class="space-y-1"></div>
        </div>

    </div>

    <script>
    // --- Config ---
    const MAX_CHUNK_SIZE = 9000; // UPDATED to 9000 as requested
    const MAX_RETRIES = 5;       
    const RETRY_DELAY = 3000;    
    const MODEL_NAME = "gemini-2.5-flash-preview-tts";

    // --- PERSONA DEFINITIONS (The "Voice Bible") ---
    // These instructions are sent with EVERY chunk to force consistency
    const PERSONA_PROMPTS = {
        "Charon": "You are Charon. Voice Traits: Deep, resonant, low-pitch, steady, authoritative. Pacing: Slow and deliberate. Emotion: Neutral and consistent.",
        "Fenrir": "You are Fenrir. Voice Traits: Energetic, high-pitched, enthusiastic, bright. Pacing: Fast and punchy. Emotion: Happy and engaging.",
        "Puck": "You are Puck. Voice Traits: Mid-tone, natural, conversational, polite. Pacing: Medium, like a helpful assistant. Emotion: Friendly.",
        "Kore": "You are Kore. Voice Traits: Firm, professional, clear articulation, mid-range pitch. Style: News anchor or documentary narrator.",
        "Aoede": "You are Aoede. Voice Traits: Soft, breathy, high-pitched, gentle. Pacing: Slow and soothing. Style: Storytelling."
    };

    // --- DOM Elements ---
    const el = (id) => document.getElementById(id);
    const elements = {
        theme: el('themeSelect'),
        input: el('textInput'),
        lang: el('langInput'),
        apiKeys: el('apiKeys'),
        remember: el('rememberKey'),
        btn: el('submitBtn'),
        btnText: el('btnText'),
        spinner: el('loadingSpinner'),
        voiceSelect: el('voiceSelect'),
        logs: el('logContent'),
        logArea: el('logArea'),
        result: el('resultArea'),
        resultStats: el('resultStats'),
        audio: el('audioPlayer'),
        download: el('downloadLink'),
        progressCont: el('progressContainer'),
        progressBar: el('progressBar'),
        progressText: el('progressText'),
        progressPercent: el('progressPercent'),
        keyBadge: el('keyCountBadge')
    };

    // --- Init ---
    window.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('tts_theme') || 'modern';
        setTheme(savedTheme);
        elements.theme.value = savedTheme;
        try {
            const savedKeys = localStorage.getItem('gemini_api_keys');
            if (savedKeys) { elements.apiKeys.value = savedKeys; elements.remember.checked = true; updateKeyCount(); }
        } catch(e) {}
        log(`System Ready. Max Chunk: ${MAX_CHUNK_SIZE}. Temp: 0.0`);
    });

    // --- Events ---
    elements.theme.addEventListener('change', (e) => setTheme(e.target.value));
    elements.apiKeys.addEventListener('input', updateKeyCount);
    elements.btn.addEventListener('click', startProcessing);

    function setTheme(theme) {
        document.body.className = `theme-${theme} min-h-screen p-4 md:p-8 transition-colors duration-500`;
        localStorage.setItem('tts_theme', theme);
    }

    function updateKeyCount() {
        const keys = elements.apiKeys.value.split('\n').map(k => k.trim()).filter(k => k);
        elements.keyBadge.textContent = keys.length > 0 ? `${keys.length} Keys` : '';
        elements.keyBadge.classList.toggle('hidden', keys.length === 0);
    }

    // --- PROCESSING LOGIC ---
    async function startProcessing() {
        const text = elements.input.value.trim();
        const rawKeys = elements.apiKeys.value;
        const voice = elements.voiceSelect.value;
        const lang = elements.lang.value.trim();
        
        const keyList = rawKeys.split('\n').map(k => k.trim()).filter(k => k.length > 10);
        
        if (keyList.length === 0) { alert("Please enter API Keys."); return; }
        if (!text) { alert("Please enter text."); return; }

        if (elements.remember.checked) { try { localStorage.setItem('gemini_api_keys', rawKeys); } catch(e){} }

        let currentKeyIndex = 0;
        elements.result.classList.add('hidden');
        elements.progressCont.classList.remove('hidden');
        elements.logs.innerHTML = '';
        updateProgress(0, 100);
        setLoading(true);

        try {
            // Split Text (Smart Splitting at 9000 chars)
            const chunks = safeSmartSplit(text, MAX_CHUNK_SIZE);
            log(`Job started: ${text.length} chars -> ${chunks.length} chunks.`);
            let allPcmData = [];

            for (let i = 0; i < chunks.length; i++) {
                updateProgress(i, chunks.length);
                
                // --- PERSONA PROMPT CONSTRUCTION ---
                const persona = PERSONA_PROMPTS[voice] || "Professional Narrator.";
                
                let prompt = `
[SYSTEM INSTRUCTION]
Role: Professional Voice Actor.
Identity: ${persona}
Constraint: Maintain consistent pitch, speed, and tone. Do not change emotion.
`;
                if (lang) prompt += `Language: ${lang}. Do not translate.\n`;
                
                prompt += `
[TEXT TO READ]:
"${chunks[i]}"
`;

                let chunkSuccess = false;
                let chunkData = null;
                let attempts = 0;

                while (!chunkSuccess && attempts < MAX_RETRIES) {
                    try {
                        const key = keyList[currentKeyIndex];
                        log(`Processing Chunk ${i+1}/${chunks.length}...`);
                        
                        // Call API with Temperature 0.0 (Deterministic)
                        chunkData = await fetchAudioWithKey(prompt, key, voice, 0.0);
                        
                        chunkSuccess = true;
                    } catch (err) {
                        attempts++;
                        const isQuota = err.message.toLowerCase().includes('quota') || err.message.includes('429');
                        
                        if (isQuota) {
                            log(`âš ï¸ Limit Hit! Rotating Key...`, true);
                            currentKeyIndex = (currentKeyIndex + 1) % keyList.length;
                        } else {
                            log(`âš ï¸ Error: ${err.message}. Retrying...`, true);
                            if (attempts < MAX_RETRIES) await new Promise(r => setTimeout(r, RETRY_DELAY));
                        }
                    }
                }

                if (!chunkSuccess) throw new Error(`Failed to process chunk ${i+1}.`);
                allPcmData.push(chunkData);
                if (i < chunks.length - 1) await new Promise(r => setTimeout(r, 1000));
            }

            log("Merging audio...");
            const finalWav = mergeWav(allPcmData);
            const blob = new Blob([finalWav], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            
            elements.audio.src = url;
            elements.download.href = url;
            elements.download.download = `Gemini_${voice}_Audio.wav`;
            elements.resultStats.textContent = `Size: ${(blob.size/1024/1024).toFixed(2)} MB | Chunks: ${chunks.length}`;
            
            elements.result.classList.remove('hidden');
            updateProgress(100, 100);
            log("âœ… Success! Audio generated.");

        } catch (err) {
            log(`âŒ FAILED: ${err.message}`, true);
            alert("Process Failed. Check logs.");
        } finally {
            setLoading(false);
        }
    }

    // --- API Helper ---
    async function fetchAudioWithKey(text, key, voice, temp) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${key}`;
        const payload = {
            contents: [{ parts: [{ text: text }] }],
            generationConfig: {
                // ZERO TEMP = ROBOTIC CONSISTENCY (PREVENTS DRIFT)
                temperature: temp, 
                responseModalities: ["AUDIO"],
                speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } } }
            }
        };

        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.error?.message || res.statusText);
        }

        const data = await res.json();
        const base64 = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
        if (!base64) throw new Error("Empty audio response");

        const bin = atob(base64);
        const bytes = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
        return bytes;
    }

    // --- Utilities ---
    function safeSmartSplit(text, limit) {
        if (text.length <= limit) return [text];
        const chunks = [];
        let remaining = text;
        while (remaining.length > 0) {
            if (remaining.length <= limit) { chunks.push(remaining); break; }
            let cutIndex = Math.max(
                remaining.substring(0, limit).lastIndexOf('\n'),
                remaining.substring(0, limit).lastIndexOf('.'),
                remaining.substring(0, limit).lastIndexOf('?'),
                remaining.substring(0, limit).lastIndexOf('!')
            );
            if (cutIndex === -1) cutIndex = remaining.substring(0, limit).lastIndexOf(' ');
            if (cutIndex === -1) cutIndex = limit; else cutIndex += 1;
            chunks.push(remaining.substring(0, cutIndex).trim());
            remaining = remaining.substring(cutIndex).trim();
        }
        return chunks;
    }

    function mergeWav(pcmArrays) {
        let len = 0; pcmArrays.forEach(p => len += p.length);
        const merged = new Uint8Array(len);
        let offset = 0; pcmArrays.forEach(p => { merged.set(p, offset); offset += p.length; });
        const buffer = new ArrayBuffer(44 + len);
        const view = new DataView(buffer);
        const sampleRate = 24000;
        writeStr(view, 0, 'RIFF'); view.setUint32(4, 36 + len, true); writeStr(view, 8, 'WAVE');
        writeStr(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true);
        view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true);
        view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true);
        view.setUint16(34, 16, true); writeStr(view, 36, 'data'); view.setUint32(40, len, true);
        new Uint8Array(buffer, 44).set(merged);
        return buffer;
    }
    function writeStr(v, o, s) { for (let i = 0; i < s.length; i++) v.setUint8(o + i, s.charCodeAt(i)); }
    
    function log(msg, err) { 
        const d = document.createElement('div'); 
        const time = new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute:'2-digit', second:'2-digit' });
        d.className = err ? 'text-red-500 font-bold' : 'opacity-80';
        d.innerHTML = `<span class="opacity-50 mr-2">[${time}]</span>${msg}`;
        elements.logs.appendChild(d); 
        requestAnimationFrame(() => { elements.logArea.scrollTop = elements.logArea.scrollHeight; });
    }

    function updateProgress(c, t) { 
        const p = Math.round((c/t)*100); 
        elements.progressBar.style.width = `${p}%`; 
        elements.progressText.textContent = `Processing... ${p}%`; 
        elements.progressPercent.textContent = `${p}%`;
    }

    function setLoading(b) { 
        elements.btn.disabled = b; 
        elements.spinner.classList.toggle('hidden', !b); 
        elements.btnText.textContent = b ? "Working..." : "Generate Audio"; 
    }
    </script>
</body>
</html>
